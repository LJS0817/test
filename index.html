<!DOCTYPE html>
<html lang="en">
<head>
    <title>shooting</title>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        function Init_Input() {
            return {
                    w: false,
                    a: false,
                    s: false,
                    d: false,
                    attack: false,
                };
        }

        class Vector2D {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }

            Add(vec) {
                this.x += vec.x;
                this.y += vec.y;
            }

            Sub(vec) {
                this.x -= vec.x;
                this.y -= vec.y;
            }

            Zero() {
                this.x = 0;
                this.y = 0;
            }
        }

        class Unit {
            constructor(pos, size, power, speed) {
                this.position = pos;
                this.size = size;
                this.attack = power;
                this.speed = speed;
                this.velocity = new Vector2D(0, 0);
            }

            Move() {
                this.position.Add(this.velocity);
            }   
            
            Clipping() {

            }

            Draw() {
                context.fillStyle = "red";
                context.fillRect(this.position.x, this.position.y, this.size.x, this.size.y);
            }

            Update() {
                this.Move();
                this.Clipping();
                this.Draw();
            }
        }

        bullet_pool = [];

        class Bullet extends Unit {
            constructor(position, angle) {
                super(new Vector2D(position.x, position.y), new Vector2D(25, 25), 0, 7);
                this.timer = 0;
                this.limitTimer = 100;
                this.velocity.x = Math.cos(angle/180*Math.PI) * 10;
                this.velocity.y = Math.sin(angle/180*Math.PI) * 10;
            }

            Clipping() {
                this.timer++;
                if(this.timer > this.limitTimer) {
                    bullet_pool.shift();
                }
            }
        }

        class Hero extends Unit {
            constructor() {
                super(new Vector2D(canvas.width / 2, canvas.height / 2), new Vector2D(25, 50), 5, 5);
                this.keys = Init_Input();
                this.backupSpeed = this.speed;
            }

            Move() {
                super.Move();
                if(this.keys.w) this.velocity.y = -this.speed;
                else if(this.keys.s) this.velocity.y = this.speed;
                else this.velocity.y = 0;

                if(this.keys.a) this.velocity.x = -this.speed;
                else if(this.keys.d) this.velocity.x = this.speed;
                else this.velocity.x = 0;
            }
        }

        hero = new Hero();
        
        class BulletManager {
            constructor() {
                this.timer = 0;
                this.limitTimer = 20;
                this.canFire = true;
                this.angle = 0;
            }

            CreateBullet() {
                if(this.canFire === false || hero.keys.attack === false) return;
                this.canFire = false;
                bullet_pool.push(new Bullet(hero.position, this.angle));
            }

            Update() {
                if(this.canFire === false)
                {
                    this.timer++;
                    if(this.timer > this.limitTimer) {
                        this.timer = 0;
                        this.canFire = true;
                    }
                }
                else this.CreateBullet();
                for(var i = 0; i < bullet_pool.length; i++) {
                    bullet_pool[i].Update();
                }
            }
        }

        bulletManager = new BulletManager();

        window.addEventListener("keydown", function(e) {
            switch(e.key) {
                case 'w':
                    hero.keys.w = true;
                    hero.keys.s = false;
                    break;
                case 'a':
                    hero.keys.a = true;
                    hero.keys.d = false;
                    break;
                case 's':
                    hero.keys.s = true;
                    hero.keys.w = false;
                    break;
                case 'd':
                    hero.keys.d = true;
                    hero.keys.a = false;
                    break;
            }
        });

        window.addEventListener("keyup", function(e) {
            switch(e.key) {
                case 'w':
                    hero.keys.w = false;
                    break;
                case 'a':
                    hero.keys.a = false;
                    break;
                case 's':
                    hero.keys.s = false;
                    break;
                case 'd':
                    hero.keys.d = false;
                    break;
            }
        });

        window.addEventListener('mousedown', function(e) {
            hero.keys.attack = true;
            var x = hero.position.x - e.clientX;
            var y = hero.position.y - e.clientY;
            var angle = Math.atan2(-y, -x) / Math.PI * 180;
            bulletManager.angle = angle;
        });

        window.addEventListener('mouseup', function(e) {
            hero.keys.attack = false;
        });

        window.addEventListener('mousemove', function(e) {
            if(hero.keys.attack === true) {
                var x = hero.position.x - e.clientX;
                var y = hero.position.y - e.clientY;
                var angle = Math.atan2(-y, -x) / Math.PI * 180;
                bulletManager.angle = angle;
            }
        });

        window.addEventListener("blur", function(e) {
            hero.velocity.Zero();
            hero.speed = 0;
a        });

        window.addEventListener('focus', function(e) {
            hero.speed = hero.backupSpeed;
            hero.keys = Init_Input();
        })

        function Update() {
            window.requestAnimationFrame(Update);
            canvas.width = canvas.width;
            hero.Update();
            bulletManager.Update();
        }

        Update();
        
    </script>

</body>
</html>